<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETL Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .alert-info {
    background: linear-gradient(45deg, #d1ecf1, #bee5eb);
    color: #0c5460;
    border-left: 4px solid #17a2b8;
}

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .sidebar-header h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .refresh-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .nav-actions {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            color: #495057;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }

        .nav-link:hover {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .nav-link.logout {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            border-color: #dc3545;
        }

        .nav-link.logout:hover {
            background: linear-gradient(45deg, #c82333, #a71e2a);
        }

        .admin-badge {
            background: #dc3545;
            color: white;
            font-size: 8px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 8px;
            text-transform: uppercase;
            margin-left: auto;
        }

        .endpoint-list {
            list-style: none;
        }

        .endpoint-item {
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: white;
            border: 2px solid #e9ecef;
        }

        .endpoint-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .endpoint-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .endpoint-item.completed {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border-color: #4CAF50;
        }

        .endpoint-item.processing {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
            border-color: #FF9800;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .endpoint-content {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .data-badge {
            font-size: 10px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            min-width: 70px;
            text-align: center;
            text-transform: uppercase;
        }

        .data-badge.health {
            background: #28a745;
            color: white;
        }

        .data-badge.weather {
            background: #17a2b8;
            color: white;
        }

        .data-badge.geo {
            background: #6f42c1;
            color: white;
        }

        .endpoint-item.active .data-badge,
        .endpoint-item.completed .data-badge,
        .endpoint-item.processing .data-badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .status-indicator {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-indicator.completed {
            background: #4CAF50;
        }

        .status-indicator.processing {
            background: #FF9800;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .endpoint-details h4 {
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 600;
        }

        .endpoint-details p {
            font-size: 12px;
            opacity: 0.8;
            margin: 0;
        }

        .main-content {
            flex: 1;
            padding: 20px;
        }

        .content-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .content-header h1 {
            font-size: 32px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .content-header p {
            font-size: 16px;
            color: #666;
            margin: 0;
        }

        .user-info-header {
            position: absolute;
            top: 20px;
            right: 30px;
            text-align: right;
        }

        .username {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .role {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 15px;
            display: inline-block;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .role.super-admin {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }

        .role.admin {
            background: linear-gradient(45deg, #28a745, #218838);
            color: white;
        }

        .role.user {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }

        .session-summary {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 3px solid #ffd700;
            position: relative;
        }

        .session-summary::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
            border-radius: 18px;
            z-index: -1;
        }

        .session-summary h3 {
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid;
        }

        .summary-card.completed {
            border-left-color: #4CAF50;
        }

        .summary-card.processing {
            border-left-color: #FF9800;
        }

        .summary-card.time {
            border-left-color: #667eea;
        }

        .summary-card.total {
            border-left-color: #17a2b8;
        }

        .summary-card h4 {
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-card p {
            color: #666;
            margin: 0;
            font-size: 16px;
            font-weight: 500;
        }

        .reset-session-btn {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .reset-session-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .messages {
            margin-bottom: 20px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .alert-success {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-error {
            background: linear-gradient(45deg, #f8d7da, #f1b0b7);
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .form-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .form-header h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .endpoint-url {
            background: #f5f5f5;
            padding: 12px 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .required {
            color: #dc3545;
        }

        .form-group input,
        .form-group select {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .text-muted {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }

        .submit-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .submit-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .submit-btn.processing {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            animation: processingPulse 2s infinite;
        }

        .submit-btn.processing::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: processingShimmer 2s infinite;
        }


        /* Session Summary Styles */
.session-summary {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 25px;
    margin: 20px 0;
    backdrop-filter: blur(10px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    border: 3px solid #ffd700;
    position: relative;
}

.session-summary::before {
    content: '';
    position: absolute;
    top: -3px;
    left: -3px;
    right: -3px;
    bottom: -3px;
    background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
    border-radius: 18px;
    z-index: -1;
}

.session-summary h3 {
    margin-bottom: 20px;
    color: #333;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 20px;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.summary-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    border-left: 4px solid;
}

.summary-card.completed {
    border-left-color: #4CAF50;
}

.summary-card.processing {
    border-left-color: #FF9800;
}

.summary-card.time {
    border-left-color: #667eea;
}

.summary-card.total {
    border-left-color: #17a2b8;
}

.summary-card h4 {
    margin-bottom: 8px;
    color: #333;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.summary-card p {
    color: #666;
    margin: 0;
    font-size: 16px;
    font-weight: 500;
}

.reset-session-btn {
    background: linear-gradient(45deg, #dc3545, #c82333);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
}

.reset-session-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

/* Status Indicators */
.status-indicator {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
}

.status-indicator.completed {
    background: #4CAF50;
}

.status-indicator.processing {
    background: #FF9800;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

/* Endpoint Item States */
.endpoint-item.completed {
    background: linear-gradient(45deg, #4CAF50, #45a049);
    color: white;
    border-color: #4CAF50;
}

.endpoint-item.processing {
    background: linear-gradient(45deg, #FF9800, #F57C00);
    color: white;
    border-color: #FF9800;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.8; }
    100% { opacity: 1; }
}

.endpoint-item.completed .data-badge,
.endpoint-item.processing .data-badge {
    background: rgba(255,255,255,0.2);
    color: white;
}
        @keyframes processingPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        @keyframes processingShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .submit-btn.completed {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            animation: completedBounce 0.6s ease;
        }

        @keyframes completedBounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3px); }
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .user-info-header {
                position: relative;
                top: auto;
                right: auto;
                text-align: center;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-list-ul"></i> Available ETL Endpoints</h3>
                <button class="refresh-btn" onclick="refreshSession()">
                    <i class="fas fa-sync-alt"></i> Refresh Session
                </button>
            </div>

            <!-- Kibana Visualization Card -->
            <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                <h3 style="margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-chart-line" style="color: #667eea;"></i> Data Visualization
                </h3>
                <p style="color: #666; margin-bottom: 20px;">Access real-time dashboards and analytics</p>
                <a href="http://localhost:5601" target="_blank" style="display: inline-flex; align-items: center; gap: 10px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease;">
                    <i class="fas fa-external-link-alt"></i> Open Kibana Dashboard
                </a>
            </div>

            <!-- Navigation Actions -->
            <div class="nav-actions">
                <a href="/upload/" class="nav-link">
                    <i class="fas fa-upload"></i> Upload Dashboard
                </a>
                
                <a href="/admin/" class="nav-link">
                    <i class="fas fa-cog"></i> Admin Panel
                    <span class="admin-badge">ADMIN</span>
                </a>
                

              <!-- Logout Link -->
                <a href="{% url 'accounts:logout' %}" class="nav-link logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
            
            <!-- Endpoint List -->
            <ul class="endpoint-list">
                <li class="endpoint-item active" data-endpoint="malaria" id="malaria-endpoint">
                    <div class="endpoint-content">
                        <span class="data-badge health">HEALTH</span>
                        <div class="endpoint-details">
                            <h4>Malaria API Calculator</h4>
                            <p>API - District Data from HMIS</p>
                        </div>
                    </div>
                    <div class="status-indicator" id="malaria-status"></div>
                </li>
                
                <li class="endpoint-item" data-endpoint="health-center" id="health-center-endpoint">
                    <div class="endpoint-content">
                        <span class="data-badge health">HEALTH</span>
                        <div class="endpoint-details">
                            <h4>Health Center Lab Data</h4>
                            <p>Extract HC Data - Laboratory Records</p>
                        </div>
                    </div>
                    <div class="status-indicator" id="health-center-status"></div>
                </li>
                
                <li class="endpoint-item" data-endpoint="weather-prec-temp" id="weather-prec-temp-endpoint">
                    <div class="endpoint-content">
                        <span class="data-badge weather">WEATHER</span>
                        <div class="endpoint-details">
                            <h4>Weather Precipitation & Temperature</h4>
                            <p>Data Meteo Rwanda</p>
                        </div>
                    </div>
                    <div class="status-indicator" id="weather-prec-temp-status"></div>
                </li>
                
                <li class="endpoint-item" data-endpoint="boundaries" id="boundaries-endpoint">
                    <div class="endpoint-content">
                        <span class="data-badge geo">GEO</span>
                        <div class="endpoint-details">
                            <h4>Admin Boundaries & Slope Data</h4>
                            <p>Extract data of boundaries & Slope</p>
                        </div>
                    </div>
                    <div class="status-indicator" id="boundaries-status"></div>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <h1><i class="fas fa-database"></i> ETL Data Processing Dashboard</h1>
                <p>Interactive interface for Rwanda Health Data ETL Operations</p>
                
                <!-- User Info Header -->
                <div class="user-info-header">
                    <div class="username">Welcome, Admin!</div>
                    <div class="role admin">Admin - Staff Access</div>
                </div>
            </div>

            <!-- Session Summary -->
            <div class="session-summary" id="session-summary" style="display: none;">
                <h3><i class="fas fa-chart-line"></i> Session Progress</h3>
                <div class="summary-grid" id="summary-grid"></div>
                <button class="reset-session-btn" onclick="resetSession()">
                    <i class="fas fa-undo"></i> Reset Session
                </button>
            </div>

            <!-- Messages -->
            <div class="messages" id="messages"></div>

            <!-- Malaria API Calculator Form -->
            <div class="form-section active" id="malaria-form">
                <div class="form-header">
                    <h2><i class="fas fa-bug"></i> Malaria API Calculator</h2>
                    <div class="endpoint-url">Calculate malaria-related metrics and statistics for specific provinces and districts</div>
                </div>
                
                <form id="malaria-etl-form" method="post">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="malaria_province">Province <span class="required">*</span></label>
                            <input type="text" id="malaria_province" name="province" placeholder="e.g., East" required>
                        </div>
                        <div class="form-group">
                            <label for="malaria_district">District <span class="required">*</span></label>
                            <input type="text" id="malaria_district" name="district" placeholder="e.g., Bugesera" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="malaria_years">Years (comma separated) <span class="required">*</span></label>
                        <input type="text" id="malaria_years" name="years" placeholder="2021,2022,2023" required>
                        <small class="text-muted">Enter years separated by commas</small>
                    </div>
                    
                    <button type="submit" class="submit-btn" id="malaria-submit-btn">
                        <i class="fas fa-calculator"></i> <span>Calculate Malaria Data</span>
                    </button>
                </form>
            </div>

            <!-- Health Center Lab Data Form -->
            <div class="form-section" id="health-center-form">
                <div class="form-header">
                    <h2><i class="fas fa-hospital"></i> Health Center Lab Data</h2>
                    <div class="endpoint-url">Process health center laboratory data with filtering by district and sector</div>
                </div>
                
                <form id="health-center-etl-form" method="post">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="hc_district">District <span class="required">*</span></label>
                            <input type="text" id="hc_district" name="district" placeholder="e.g., Bugesera" required>
                        </div>
                        <div class="form-group">
                            <label for="hc_sector">Sector <span class="required">*</span></label>
                            <input type="text" id="hc_sector" name="sector" placeholder="e.g., Kamabuye" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="hc_years">Years (comma separated) <span class="required">*</span></label>
                        <input type="text" id="hc_years" name="years" placeholder="2021,2022,2023" required>
                        <small class="text-muted">Enter years separated by commas</small>
                    </div>
                    
                    <button type="submit" class="submit-btn" id="health-center-submit-btn">
                        <i class="fas fa-database"></i> <span>Process Health Center Data</span>
                    </button>
                </form>
            </div>

            <!-- Weather Precipitation & Temperature Form -->
            <div class="form-section" id="weather-prec-temp-form">
                <div class="form-header">
                    <h2><i class="fas fa-cloud-rain"></i> Weather Precipitation & Temperature</h2>
                    <div class="endpoint-url">Process precipitation and temperature data from specific stations</div>
                </div>
                
                <form id="weather-prec-temp-etl-form" method="post">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="station_temp">Temperature Station</label>
                            <input type="text" id="station_temp" name="station_temp" placeholder="e.g., Nyamata">
                            <small class="text-muted">Optional - leave blank for all stations</small>
                        </div>
                        <div class="form-group">
                            <label for="station_prec">Precipitation Station</label>
                            <input type="text" id="station_prec" name="station_prec" placeholder="e.g., Juru">
                            <small class="text-muted">Optional - leave blank for all stations</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="weather_years">Years (comma separated) <span class="required">*</span></label>
                        <input type="text" id="weather_years" name="years" placeholder="2021,2022,2023" required>
                        <small class="text-muted">Enter years separated by commas</small>
                    </div>
                    
                    <button type="submit" class="submit-btn" id="weather-submit-btn">
                        <i class="fas fa-thermometer-half"></i> <span>Process Weather Data</span>
                    </button>
                </form>
            </div>

            <!-- Admin Boundaries Form -->
            <div class="form-section" id="boundaries-form">
                <div class="form-header">
                    <h2><i class="fas fa-map-marked-alt"></i> Administrative Boundaries with Slope Data</h2>
                    <div class="endpoint-url">Extract Rwanda administrative boundaries with slope analysis</div>
                </div>
                
                <form id="boundaries-etl-form" method="post">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bounds_province">Province (Optional)</label>
                            <select id="bounds_province" name="province">
                                <option value="">All Provinces</option>
                                <option value="Amajyepfo">Amajyepfo (South)</option>
                                <option value="Amajyaruguru">Amajyaruguru (North)</option>
                                <option value="Iburengerazuba">Iburengerazuba (West)</option>
                                <option value="Iburasirazuba">Iburasirazuba (East)</option>
                                <option value="Kigali">Kigali</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="bounds_district">District</label>
                            <input type="text" id="bounds_district" name="district" placeholder="e.g., Gisagara, Bugesera">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bounds_sector">Sector</label>
                            <input type="text" id="bounds_sector" name="sector" placeholder="e.g., Mugombwa, Kamabuye">
                        </div>
                        <div class="form-group">
                            <label for="update_mode_boundaries">Update Mode</label>
                            <select id="update_mode_boundaries" name="update_mode">
                                <option value="replace">Replace Table (Drop & Create)</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="submit-btn" id="boundaries-submit-btn">
                        <i class="fas fa-map"></i> <span>Extract Boundary Data</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ETL Session Manager matching Upload approach
// CSRF Token Helper Functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function getCSRFToken() {
    return getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
}

// ETL Session Manager with Proper State Management
class ETLSessionManager {
    constructor() {
        this.sessionData = this.loadSession();
        this.initializeEventListeners();
        this.updateUI();
        this.createSessionSummary();
    }

    loadSession() {
        const saved = localStorage.getItem('etl_session');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                return {
                    completedETLs: data.completedETLs || {},
                    processingETLs: new Set(data.processingETLs || []),
                    sessionStartTime: data.sessionStartTime || Date.now()
                };
            } catch (e) {
                console.error('Error loading session:', e);
            }
        }
        return {
            completedETLs: {},
            processingETLs: new Set(),
            sessionStartTime: Date.now()
        };
    }

    saveSession() {
        const dataToSave = {
            ...this.sessionData,
            processingETLs: Array.from(this.sessionData.processingETLs)
        };
        localStorage.setItem('etl_session', JSON.stringify(dataToSave));
        this.sessionData.processingETLs = new Set(dataToSave.processingETLs);
    }

    initializeEventListeners() {
        // Sidebar navigation
        document.querySelectorAll('.endpoint-item').forEach(item => {
            item.addEventListener('click', () => {
                const endpointType = item.dataset.endpoint;
                
                // ⭐ PREVENT CLICKING ON DISABLED/COMPLETED ITEMS
                if (item.classList.contains('disabled') || 
                    item.classList.contains('completed') || 
                    item.classList.contains('processing')) {
                    this.showMessage('info', 'This ETL has already been processed. Use "Refresh Session" to reset.');
                    return;
                }
                
                this.switchEndpoint(endpointType);
            });
        });

        // Form submissions with session tracking
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const endpointType = this.getEndpointTypeFromForm(form);
                
                // ⭐ CHECK IF ALREADY COMPLETED OR PROCESSING
                if (this.sessionData.completedETLs[endpointType]) {
                    this.showMessage('error', 'This ETL has already been completed. Please refresh the session to run again.');
                    return;
                }
                
                if (this.sessionData.processingETLs.has(endpointType)) {
                    this.showMessage('error', 'This ETL is already processing. Please wait.');
                    return;
                }
                
                this.handleETLSubmission(endpointType, form);
            });
        });
    }

    getEndpointTypeFromForm(form) {
        const formId = form.id || form.closest('.form-section')?.id;
        if (formId) {
            return formId.replace('-form', '').replace('-etl-form', '');
        }
        return 'unknown';
    }

    switchEndpoint(endpointType) {
        // Update sidebar
        document.querySelectorAll('.endpoint-item').forEach(item => {
            item.classList.remove('active');
        });
        const targetItem = document.querySelector(`[data-endpoint="${endpointType}"]`);
        if (targetItem) targetItem.classList.add('active');

        // Update forms
        document.querySelectorAll('.form-section').forEach(section => {
            section.classList.remove('active');
        });
        const targetForm = document.getElementById(`${endpointType}-form`);
        if (targetForm) targetForm.classList.add('active');
    }

    async handleETLSubmission(endpointType, form) {
        const formData = new FormData(form);
        const submitBtn = form.querySelector('.submit-btn, button[type="submit"]');
        const btnContent = submitBtn.innerHTML;
        
        // ⭐ SET PROCESSING STATE IMMEDIATELY
        this.setEndpointStatus(endpointType, 'processing');
        this.sessionData.processingETLs.add(endpointType);
        this.saveSession();
        this.updateSessionSummary();

        // Enhanced button processing state
        submitBtn.disabled = true;
        submitBtn.style.background = 'linear-gradient(45deg, #FF9800, #F57C00)';
        submitBtn.innerHTML = `
            <div class="loading-spinner" style="display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite;"></div>
            <span style="margin-left: 10px;">Processing ${this.getEndpointDisplayName(endpointType)}...</span>
        `;

        // Add CSS animation if not exists
        if (!document.getElementById('spin-animation')) {
            const style = document.createElement('style');
            style.id = 'spin-animation';
            style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
            document.head.appendChild(style);
        }

        // Processing dots animation
        let dots = 0;
        const dotsInterval = setInterval(() => {
            dots = (dots + 1) % 4;
            const span = submitBtn.querySelector('span');
            if (span) {
                span.textContent = `Processing ${this.getEndpointDisplayName(endpointType)}${'.'.repeat(dots)}`;
            }
        }, 500);

        // Show processing message for long-running ETLs
        if (['health-center', 'boundaries'].includes(endpointType)) {
            this.showMessage('info', 
                'Processing large dataset... This may take 5-10 minutes. Please wait.'
            );
        }

        try {
            const csrftoken = getCSRFToken();
            
            const response = await fetch(form.action || window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                }
            });

            // ⭐ ALWAYS CLEAR INTERVAL WHEN DONE
            clearInterval(dotsInterval);

            if (response.ok) {
                const data = await response.json().catch(() => ({}));
                
                // ⭐ SUCCESS STATE - REMOVE FROM PROCESSING, ADD TO COMPLETED
                this.sessionData.processingETLs.delete(endpointType);
                this.sessionData.completedETLs[endpointType] = {
                    recordsProcessed: data.records_processed || data.recordsProcessed || 'N/A',
                    timestamp: new Date().toISOString(),
                    tableName: data.table_name || data.tableName
                };
                this.saveSession();
                
                // Update button to success state
                submitBtn.style.background = 'linear-gradient(45deg, #4CAF50, #45a049)';
                submitBtn.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <span style="margin-left: 10px;">ETL Completed Successfully!</span>
                `;
                
                // ⭐ SET STATUS TO COMPLETED AND DISABLE
                this.setEndpointStatus(endpointType, 'completed');
                this.disableEndpoint(endpointType);
                this.updateSessionSummary();
                
                this.showMessage('success', 
                    `${this.getEndpointDisplayName(endpointType)} ETL completed! ${data.message || ''}`
                );
                
                // Reset form after delay
                setTimeout(() => form.reset(), 2000);
                
                // Keep button in completed state permanently
                setTimeout(() => {
                    submitBtn.style.background = 'linear-gradient(45deg, #4CAF50, #45a049)';
                    submitBtn.innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        <span style="margin-left: 10px;">Already Completed - Refresh to Re-run</span>
                    `;
                    submitBtn.disabled = true;
                }, 4000);
                
            } else {
                throw new Error(`Server returned ${response.status}`);
            }
        } catch (error) {
            // ⭐ ERROR HANDLING - CLEAR PROCESSING STATE
            clearInterval(dotsInterval);
            console.error('ETL Error:', error);
            
            // Remove from processing on error
            this.sessionData.processingETLs.delete(endpointType);
            this.saveSession();
            this.setEndpointStatus(endpointType, 'idle');
            this.updateSessionSummary();
            
            // Error state
            submitBtn.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
            submitBtn.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <span style="margin-left: 10px;">ETL Failed - Try Again</span>
            `;
            
            this.showMessage('error', 
                `Error processing ${this.getEndpointDisplayName(endpointType)}: ${error.message}`
            );
            
            // Reset button after 3 seconds on error
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.style.background = '';
                submitBtn.innerHTML = btnContent;
            }, 3000);
        }
    }

    getEndpointDisplayName(endpointType) {
        const names = {
            'malaria': 'Malaria API Calculator',
            'health-center': 'Health Center Lab Data',
            'weather-prec-temp': 'Weather Precipitation & Temperature',
            'boundaries': 'Admin Boundaries & Slope Data'
        };
        return names[endpointType] || endpointType.charAt(0).toUpperCase() + endpointType.slice(1);
    }

    disableEndpoint(endpointType) {
        const card = document.querySelector(`[data-endpoint="${endpointType}"]`);
        if (card) {
            card.classList.add('disabled');
            card.style.opacity = '0.6';
            card.style.cursor = 'not-allowed';
        }
        
        // Disable the form submit button permanently
        const form = document.getElementById(`${endpointType}-form`) || 
                     document.getElementById(`${endpointType}-etl-form`);
        if (form) {
            const submitBtn = form.querySelector('.submit-btn, button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
            }
        }
    }

    setEndpointStatus(endpointType, status) {
        const card = document.querySelector(`[data-endpoint="${endpointType}"]`);
        if (!card) return;
        
        // Remove all status classes
        card.classList.remove('completed', 'processing');
        
        // Add status indicator if it doesn't exist
        let statusIndicator = card.querySelector('.status-indicator');
        if (!statusIndicator) {
            statusIndicator = document.createElement('div');
            statusIndicator.className = 'status-indicator';
            card.appendChild(statusIndicator);
        }
        statusIndicator.classList.remove('completed', 'processing');
        
        // Add appropriate status class
        if (status === 'completed') {
            card.classList.add('completed');
            statusIndicator.classList.add('completed');
        } else if (status === 'processing') {
            card.classList.add('processing');
            statusIndicator.classList.add('processing');
        }
    }

    createSessionSummary() {
        if (document.getElementById('session-summary')) return;
        
        const summary = document.createElement('div');
        summary.id = 'session-summary';
        summary.className = 'session-summary';
        summary.style.display = 'none';
        summary.innerHTML = `
            <h3><i class="fas fa-chart-line"></i> Session Progress</h3>
            <div class="summary-grid" id="summary-grid"></div>
            <button class="reset-session-btn" onclick="window.etlManager.resetSession()">
                <i class="fas fa-undo"></i> Reset Session
            </button>
        `;
        
        const header = document.querySelector('.dashboard-header, .content-header');
        if (header) {
            header.insertAdjacentElement('afterend', summary);
        }
    }

    updateUI() {
        // Update endpoint statuses on page load
        Object.keys(this.sessionData.completedETLs).forEach(endpointType => {
            this.setEndpointStatus(endpointType, 'completed');
            this.disableEndpoint(endpointType);
        });
        
        // If there are any processing ETLs from before (page refresh), clear them
        // since we don't actually know if they're still processing
        if (this.sessionData.processingETLs.size > 0) {
            console.warn('Clearing stale processing states from previous session');
            this.sessionData.processingETLs.clear();
            this.saveSession();
        }
        
        this.updateSessionSummary();
    }

    updateSessionSummary() {
        const summaryDiv = document.getElementById('session-summary');
        const summaryGrid = document.getElementById('summary-grid');
        
        if (!summaryDiv || !summaryGrid) return;
        
        const completedCount = Object.keys(this.sessionData.completedETLs).length;
        const processingCount = this.sessionData.processingETLs.size;
        
        if (completedCount > 0 || processingCount > 0) {
            summaryDiv.style.display = 'block';
            summaryGrid.innerHTML = '';
            
            // Completed ETLs
            if (completedCount > 0) {
                const completedCard = document.createElement('div');
                completedCard.className = 'summary-card completed';
                completedCard.innerHTML = `
                    <h4><i class="fas fa-check-circle" style="color: #4CAF50;"></i> Completed Tasks</h4>
                    <p>${completedCount} ETL${completedCount > 1 ? 's' : ''} processed</p>
                `;
                summaryGrid.appendChild(completedCard);
            }
            
            // Processing ETLs
            if (processingCount > 0) {
                const processingCard = document.createElement('div');
                processingCard.className = 'summary-card processing';
                processingCard.innerHTML = `
                    <h4><i class="fas fa-spinner fa-spin" style="color: #FF9800;"></i> Processing</h4>
                    <p>${processingCount} ETL${processingCount > 1 ? 's' : ''} in progress</p>
                `;
                summaryGrid.appendChild(processingCard);
            }
            
            // Session time
            const sessionTime = Math.floor((Date.now() - this.sessionData.sessionStartTime) / 1000 / 60);
            const timeCard = document.createElement('div');
            timeCard.className = 'summary-card time';
            timeCard.innerHTML = `
                <h4><i class="fas fa-clock" style="color: #667eea;"></i> Session Time</h4>
                <p>${sessionTime} minute${sessionTime !== 1 ? 's' : ''} active</p>
            `;
            summaryGrid.appendChild(timeCard);
            
            // Total records
            const totalRecords = Object.values(this.sessionData.completedETLs)
                .reduce((sum, etl) => {
                    const records = parseInt(etl.recordsProcessed) || 0;
                    return sum + records;
                }, 0);
            
            if (totalRecords > 0) {
                const recordsCard = document.createElement('div');
                recordsCard.className = 'summary-card total';
                recordsCard.innerHTML = `
                    <h4><i class="fas fa-database" style="color: #17a2b8;"></i> Total Records</h4>
                    <p>${totalRecords.toLocaleString()} processed</p>
                `;
                summaryGrid.appendChild(recordsCard);
            }
        } else {
            summaryDiv.style.display = 'none';
        }
    }

    showMessage(type, message) {
        let messagesDiv = document.querySelector('.messages');
        if (!messagesDiv) {
            messagesDiv = document.createElement('div');
            messagesDiv.className = 'messages';
            const contentArea = document.querySelector('.content-area, .main-content');
            if (contentArea) {
                contentArea.insertBefore(messagesDiv, contentArea.firstChild);
            }
        }
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'success' ? 'success' : type === 'info' ? 'info' : 'error'}`;
        
        const icon = type === 'success' ? 'check-circle' : 
                     type === 'info' ? 'info-circle' : 'exclamation-triangle';
        alertDiv.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
        
        messagesDiv.appendChild(alertDiv);
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            alertDiv.style.transition = 'opacity 0.5s ease';
            alertDiv.style.opacity = '0';
            setTimeout(() => alertDiv.remove(), 500);
        }, 5000);
    }

    resetSession() {
        if (confirm('Are you sure you want to reset the current ETL session? This will clear all completion status.')) {
            this.sessionData = {
                completedETLs: {},
                processingETLs: new Set(),
                sessionStartTime: Date.now()
            };
            this.saveSession();
            
            // Reset UI completely
            document.querySelectorAll('.endpoint-item').forEach(item => {
                item.classList.remove('completed', 'processing', 'disabled');
                item.style.opacity = '';
                item.style.cursor = '';
            });
            
            document.querySelectorAll('.status-indicator').forEach(indicator => {
                indicator.classList.remove('completed', 'processing');
            });
            
            // Re-enable all submit buttons
            document.querySelectorAll('.submit-btn').forEach(btn => {
                btn.disabled = false;
                btn.style.background = '';
                const endpointType = btn.closest('form')?.id?.replace('-form', '').replace('-etl-form', '');
                if (endpointType) {
                    const originalIcon = btn.querySelector('i')?.className || 'fas fa-calculator';
                    const displayName = this.getEndpointDisplayName(endpointType);
                    btn.innerHTML = `<i class="${originalIcon}"></i> <span>Process ${displayName}</span>`;
                }
            });
            
            this.updateSessionSummary();
            this.showMessage('success', 'ETL session reset successfully! All endpoints are now available.');
        }
    }

    refreshSession() {
        this.resetSession();
    }
}

// Global functions
function resetSession() {
    window.etlManager.resetSession();
}

function refreshSession() {
    window.etlManager.refreshSession();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    window.etlManager = new ETLSessionManager();
    console.log('ETL Dashboard with session management loaded successfully');
});
    </script>
</body>
</html>
