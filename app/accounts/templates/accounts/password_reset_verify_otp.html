{% extends "accounts/base_auth.html" %}
{% load static %}
{% block title %}Verify Code{% endblock %}

{% block content %}
<div class="auth-logo">
  <img src="{% static 'accounts/Images/upanzi-network-logo.png' %}" alt="Upanzi Network">
</div>

<div class="form-container">
  <!-- Icon -->
  <div style="text-align: center; margin-bottom: 24px;">
    <div style="display: inline-flex; align-items: center; justify-content: center; width: 64px; height: 64px; background: #e8f0fe; border-radius: 50%;">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#4285f4" stroke-width="2">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
    </div>
  </div>

  <h2 style="color: #202124; font-size: 24px; font-weight: 400; margin-bottom: 8px; text-align: center;">
    Reset your password
  </h2>
  <p style="color: #5f6368; font-size: 14px; margin-bottom: 32px; text-align: center;">
    Enter the code we sent to <strong>{{ masked_email }}</strong><br>
    and create your new password
  </p>

  <!-- Messages -->
  {% if messages %}
    <div class="messages" style="margin-bottom: 24px;">
      {% for message in messages %}
        <div class="message {{ message.tags }}" style="padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; font-size: 14px;
             {% if message.tags == 'success' %}background: #e6f4ea; color: #137333; border: 1px solid #c2e7d0;
             {% elif message.tags == 'error' %}background: #fce8e6; color: #c5221f; border: 1px solid #f6aea9;
             {% else %}background: #e8f0fe; color: #1967d2; border: 1px solid #d2e3fc;{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <form method="post">
    {% csrf_token %}
    
    <!-- Verification Code -->
    <div class="form-field" style="margin-bottom: 20px;">
      <label for="otp_code" style="display: block; color: #5f6368; font-size: 14px; font-weight: 500; margin-bottom: 8px;">
        Verification code
      </label>
      <input 
        type="text" 
        name="otp_code" 
        id="otp_code" 
        class="form-input" 
        placeholder="000000"
        maxlength="6"
        required
        autofocus
        style="width: 100%; padding: 12px 16px; border: 1px solid #dadce0; border-radius: 8px; font-size: 24px; font-family: monospace; text-align: center; letter-spacing: 8px; transition: all 0.2s;"
        onfocus="this.style.borderColor='#4285f4'; this.style.boxShadow='0 1px 6px rgba(66,133,244,0.3)';"
        onblur="this.style.borderColor='#dadce0'; this.style.boxShadow='none';"
      >
      <small style="display: block; margin-top: 8px; color: #80868b; font-size: 12px; text-align: center;">
        Enter the 6-digit code from your email
      </small>
    </div>

    <!-- New Password -->
    <div class="form-field" style="margin-bottom: 20px;">
      <label for="new_password1" style="display: block; color: #5f6368; font-size: 14px; font-weight: 500; margin-bottom: 8px;">
        New password
      </label>
      <input 
        type="password" 
        name="new_password1" 
        id="new_password1" 
        class="form-input" 
        placeholder="Enter new password"
        autocomplete="new-password" 
        required
        style="width: 100%; padding: 12px 16px; border: 1px solid #dadce0; border-radius: 8px; font-size: 14px; transition: all 0.2s;"
        onfocus="this.style.borderColor='#4285f4'; this.style.boxShadow='0 1px 6px rgba(66,133,244,0.3)';"
        onblur="this.style.borderColor='#dadce0'; this.style.boxShadow='none';"
      >
      <small style="display: block; margin-top: 6px; color: #80868b; font-size: 12px;">
        At least 8 characters
      </small>
    </div>

    <!-- Confirm Password -->
    <div class="form-field" style="margin-bottom: 24px;">
      <label for="new_password2" style="display: block; color: #5f6368; font-size: 14px; font-weight: 500; margin-bottom: 8px;">
        Confirm password
      </label>
      <input 
        type="password" 
        name="new_password2" 
        id="new_password2" 
        class="form-input" 
        placeholder="Re-enter new password"
        autocomplete="new-password" 
        required
        style="width: 100%; padding: 12px 16px; border: 1px solid #dadce0; border-radius: 8px; font-size: 14px; transition: all 0.2s;"
        onfocus="this.style.borderColor='#4285f4'; this.style.boxShadow='0 1px 6px rgba(66,133,244,0.3)';"
        onblur="this.style.borderColor='#dadce0'; this.style.boxShadow='none';"
      >
    </div>

    <button 
      type="submit" 
      style="width: 100%; padding: 12px 24px; background: #4285f4; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"
      onmouseover="this.style.background='#1a73e8';"
      onmouseout="this.style.background='#4285f4';"
    >
      Reset password
    </button>
  </form>

  <!-- Resend Code -->
  <div style="text-align: center; margin-top: 24px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
    <p style="color: #5f6368; font-size: 13px; margin: 0 0 12px 0;">
      Didn't receive the code?
    </p>
    <button 
      id="resend-btn" 
      onclick="resendOTP()"
      type="button"
      style="background: transparent; color: #4285f4; border: 1px solid #dadce0; padding: 8px 20px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s;"
      onmouseover="this.style.background='#f8f9fa'; this.style.borderColor='#4285f4';"
      onmouseout="this.style.background='transparent'; this.style.borderColor='#dadce0';"
    >
      Resend code
    </button>
    <p id="resend-message" style="margin: 8px 0 0 0; font-size: 12px;"></p>
  </div>

  <div style="margin-top: 24px; text-align: center; padding-top: 24px; border-top: 1px solid #e8eaed;">
    <p style="color: #5f6368; font-size: 14px; margin: 0;">
      <a href="{% url 'accounts:login' %}" style="color: #4285f4; text-decoration: none; font-weight: 500;">
        ← Back to login
      </a>
    </p>
  </div>
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function resendOTP() {
  const btn = document.getElementById('resend-btn');
  const message = document.getElementById('resend-message');
  
  btn.disabled = true;
  btn.textContent = 'Sending...';
  
  fetch("{% url 'accounts:resend_password_reset_otp' %}", {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json',
    },
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      message.textContent = '✓ ' + data.message;
      message.style.color = '#34a853';
      
      let countdown = 60;
      const timer = setInterval(() => {
        btn.textContent = `Resend code (${countdown}s)`;
        countdown--;
        
        if (countdown < 0) {
          clearInterval(timer);
          btn.disabled = false;
          btn.textContent = 'Resend code';
        }
      }, 1000);
    } else {
      message.textContent = '✗ ' + data.message;
      message.style.color = '#ea4335';
      btn.disabled = false;
      btn.textContent = 'Resend code';
    }
  })
  .catch(error => {
    message.textContent = '✗ An error occurred';
    message.style.color = '#ea4335';
    btn.disabled = false;
    btn.textContent = 'Resend code';
  });
}

// Only allow numbers in OTP
document.getElementById('otp_code').addEventListener('input', function(e) {
  this.value = this.value.replace(/\D/g, '').substring(0, 6);
});
</script>

<style>
.form-input:focus { outline: none; }
</style>
{% endblock %}
