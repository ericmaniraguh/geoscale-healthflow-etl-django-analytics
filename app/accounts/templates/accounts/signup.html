{% extends "accounts/base_auth.html" %}
{% load static %}
{% block title %}Sign Up{% endblock %}

{% block content %}
<style>
  /* Inlined styles to ensure layout applies immediately */
  .signup-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px; /* Tighter gap */
    margin-bottom: 10px;
    align-items: start;
  }
  
  .signup-columns .form-field {
    margin-bottom: 0.3rem; /* Very tight spacing */
  }

  /* Compact Inputs */
  .signup-columns input, 
  .signup-columns select {
    padding: 8px 10px !important;
    font-size: 0.85rem !important;
    height: auto !important;
  }
  
  .signup-columns label {
    font-size: 0.8rem !important;
    margin-bottom: 0.1rem !important;
  }

  @media (max-width: 600px) {
    .signup-columns {
      grid-template-columns: 1fr;
      gap: 0;
    }
  }

  .form-container {
    padding-top: 40px !important; /* Moved up */
  }

  .form-container.wide {
    max-width: 900px !important;
  }
  
  .form-container h2 {
    font-size: 1.4rem !important;
    margin-bottom: 0.5rem !important;
  }

  /* Force scrollbar hiding - content fits viewport */
  .auth-right {
    overflow-y: hidden !important; /* Completely disable scrolling */
    scrollbar-width: none !important;
    -ms-overflow-style: none !important;
    padding: 0.5rem !important;
  }
  
  .auth-right::-webkit-scrollbar {
    display: none !important;
    width: 0 !important;
    height: 0 !important; 
    background: transparent !important;
  }

  /* Logo in top-right corner */
  .auth-logo {
    position: absolute !important;
    top: 40px !important; /* "A bit down" */
    right: 40px !important;
    z-index: 10;
    margin: 0 !important;
    text-align: right !important;
    width: auto !important;
  }

  .auth-logo img {
    height: 50px !important;
    width: auto !important;
  }

  /* Login Link Area */
  .alt-action {
    text-align: center;
    border-top: 1px solid #e8eaed;
    padding-top: 20px;
    margin-top: 24px;
  }
  
  .alt-action p {
    font-size: 0.9rem;
    color: #666;
    margin: 0;
  }

  .alt-action a {
    color: #1d4ed8;
    text-decoration: none;
    font-weight: 600;
  }
  
  .alt-action a:hover {
    text-decoration: underline;
  }

  /* Agreement Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
  }
  
  .modal-content {
    background-color: #fff;
    padding: 24px;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    border-bottom: 1px solid #eee;
    padding-bottom: 12px;
  }
  
  .modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
    color: #202124;
  }
  
  .close-modal {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
  }
  
  .close-modal:hover {
    color: #000;
  }
  
  .modal-body {
    font-size: 0.9rem;
    line-height: 1.6;
    color: #444;
  }
  
  .agreement-checkbox {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 16px;
    font-size: 0.8rem;
    color: #444;
  }
  
  .agreement-checkbox input[type="checkbox"] {
    margin-top: 2px;
    width: auto !important;
  }
</style>

<div id="page-loader" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.3s ease-out;">
  <div style="text-align: center;">
    
    <div style="margin-bottom: 24px;">
      <img src="{% static 'accounts/Images/upanzi-network-logo.png' %}" 
           alt="Upanzi Network" 
           style="height: 60px; width: auto; opacity: 0.9;"
           onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
      <div style="display: none; font-size: 24px; font-weight: 600; color: #1967d2;">
        Upanzi Network
      </div>
    </div>
    
    <div style="position: relative; width: 48px; height: 48px; margin: 0 auto 16px;">
      <svg width="48" height="48" viewBox="0 0 48 48" style="animation: spin 1s linear infinite;">
        <circle cx="24" cy="24" r="20" 
                stroke="#4285f4" 
                stroke-width="4" 
                fill="none" 
                stroke-dasharray="90 31.4" 
                stroke-linecap="round"/>
      </svg>
    </div>
    
    <p style="color: #5f6368; font-size: 14px; margin: 0; font-weight: 500;">
      <span id="loading-dots">Loading</span>
    </p>
  </div>
</div>

<div class="auth-wrapper" id="main-content" style="opacity: 0;">
  
  <div class="auth-left">
    <div class="auth-overlay" style="background: linear-gradient(135deg, rgba(236, 253, 245, 0.9) 0%, rgba(209, 250, 229, 0.9) 100%);"></div>
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 3; text-align: center; width: 100%; padding: 20px;">
        <img src="{% static 'accounts/Images/geoscale-malaria-illustration.png' %}" 
              alt="GeoScale Malaria" 
              style="max-width: 80%; height: auto; max-height: 60vh; filter: drop-shadow(0 10px 20px rgba(21, 128, 61, 0.2));"
              onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\'font-size: 100px; color: rgba(21, 128, 61, 0.3);\'>üåç</div>';">
    </div>
  </div>
  
  <div class="auth-right">
    
    <div class="auth-logo">
      <img src="{% static 'accounts/Images/upanzi-network-logo.png' %}" alt="Upanzi Network">
    </div>
    
    <div class="form-container wide">
      
      <h2>Register your account</h2>
      <p>Fill the details below to register your account.</p>

      {% if messages %}
        <div class="messages">
          {% for message in messages %}
            <div class="message {{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <form method="post" novalidate id="signup-form">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
          <div class="error-messages">{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="signup-columns">
          
          <!-- Row 1 -->
          <div class="form-field">
            <label for="id_first_name">First name *</label>
            <input type="text" name="first_name" id="id_first_name" placeholder="First name" value="{{ form.first_name.value|default:'' }}" required>
            {% if form.first_name.errors %} <span class="field-error">{{ form.first_name.errors }}</span>{% endif %}
          </div>

          <div class="form-field">
            <label for="id_last_name">Last name *</label>
            <input type="text" name="last_name" id="id_last_name" placeholder="Last name" value="{{ form.last_name.value|default:'' }}" required>
            {% if form.last_name.errors %} <span class="field-error">{{ form.last_name.errors }}</span>{% endif %}
          </div>

          <!-- Row 2 -->
          <div class="form-field">
            <label for="id_email">Email address *</label>
            <input type="email" name="email" id="id_email" placeholder="Email" value="{{ form.email.value|default:'' }}" required>
            {% if form.email.errors %} <span class="field-error">{{ form.email.errors }}</span>{% endif %}
          </div>

          <div class="form-field">
            <label for="id_phone_number">Phone number *</label>
            <input type="tel" name="phone_number" id="id_phone_number" placeholder="Phone number" value="{{ form.phone_number.value|default:'' }}" required>
            {% if form.phone_number.errors %} <span class="field-error">{{ form.phone_number.errors }}</span>{% endif %}
          </div>

          <!-- Row 3 -->
          <div class="form-field">
            <label for="id_username">Username *</label>
            <input type="text" name="username" id="id_username" placeholder="Username" value="{{ form.username.value|default:'' }}" required>
            {% if form.username.errors %} <span class="field-error">{{ form.username.errors }}</span>{% endif %}
          </div>

          <div class="form-field">
            <label for="id_health_centre_name">Health centre *</label>
            <input type="text" name="health_centre_name" id="id_health_centre_name" placeholder="Health centre name" value="{{ form.health_centre_name.value|default:'' }}" required>
          </div>

          <!-- Row 4 -->
          <div class="form-field">
            <label for="id_position">Position</label>
            {{ form.position }}
          </div>

          <!-- HTMX Cascading Dropdowns -->
          <div class="form-field" style="position: relative;">
            <label for="id_province">Province</label>
            <select id="id_province" name="province" 
                    hx-get="/accounts/ajax/districts/" hx-target="#district-container" hx-trigger="change" hx-indicator="#loading-districts" hx-include="[name='csrfmiddlewaretoken']">
              <option value="">Select province</option>
              {% for province in form.fields.province.queryset %}
                <option value="{{ province.id }}">{{ province.name }}</option>
              {% endfor %}
            </select>
            <div id="loading-districts" class="loading-indicator" style="display: none;">
              <div class="spinner"></div><span>Loading...</span>
            </div>
          </div>
          
          <!-- Row 5 -->
          <div class="form-field" id="district-container" style="position: relative;">
            <label for="id_district">District</label>
            <select id="id_district" name="district"
                    hx-get="/accounts/ajax/sectors/" hx-target="#sector-container" hx-trigger="change" hx-indicator="#loading-sectors" hx-include="[name='csrfmiddlewaretoken']">
              <option value="">Select district</option>
            </select>
            <div id="loading-sectors" class="loading-indicator" style="display: none;">
              <div class="spinner"></div><span>Loading...</span>
            </div>
          </div>
          
          <div class="form-field" id="sector-container">
            <label for="id_sector">Sector</label>
            <select id="id_sector" name="sector">
              <option value="">Select sector</option>
            </select>
          </div>

          <!-- Row 6 -->
          <div class="form-field">
          <label for="id_password1">Password *</label>
          <input type="password" name="password1" id="id_password1" placeholder="Password" required>
          {% if form.password1.errors %} <span class="field-error">{{ form.password1.errors }}</span>{% endif %}
          </div>

          <div class="form-field">
          <label for="id_password2">Confirm password *</label>
          <input type="password" name="password2" id="id_password2" placeholder="Confirm password" required>
          {% if form.password2.errors %} <span class="field-error">{{ form.password2.errors }}</span>{% endif %}
          </div>
          
        </div>

        <div class="agreement-checkbox">
            {{ form.terms_accepted }}
            <label for="id_terms_accepted">
              I have read and agree to the <a href="#" id="terms-link" style="color: #1d4ed8; text-decoration: none;">Terms & Conditions</a> and <a href="#" id="privacy-link" style="color: #1d4ed8; text-decoration: none;">Privacy Policy</a>.
            </label>
        </div>
        {% if form.terms_accepted.errors %} <div class="field-error" style="margin-bottom: 10px; display: block;">{{ form.terms_accepted.errors }}</div>{% endif %}

        <input type="hidden" name="country" value="Rwanda">

        <button type="submit" id="submit-btn" class="btn-primary" style="position: relative;">
          <span id="btn-text">Create Account</span>
          <span id="btn-spinner" style="display: none;">
            <svg style="animation: spin 1s linear infinite; width: 16px; height: 16px; display: inline-block; vertical-align: middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="10" stroke-width="3" stroke-dasharray="31.4 31.4" stroke-linecap="round"/>
            </svg>
            Creating...
          </span>
        </button>
        <div class="alt-action">
          <p>Already have an account? <a href="{% url 'accounts:login' %}">Login</a></p>
        </div>

      </form>
      
    </div>
  </div>
</div>

<!-- Terms Modal -->
<div id="terms-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Terms & Conditions & Privacy Policy</h3>
      <span class="close-modal">&times;</span>
    </div>
    <div class="modal-body">
      <strong>Terms & Conditions</strong><br>
      <ol style="padding-left: 20px; margin-bottom: 20px;">
        <li>Use of this service is subject to the data protection laws of Rwanda.</li>
        <li>You agree to provide accurate and up-to-date information.</li>
        <li>Your data will be used solely for the purpose of the GeoScale Malaria project.</li>
        <li>Unauthorized access or misuse of the platform is strictly prohibited.</li>
        <li>We reserve the right to suspend accounts that violate these terms.</li>
      </ol>

      <strong>Privacy Policy</strong><br>
      <p>We respect your privacy. Your personal information will be securely stored and not shared with third parties without your consent, except as required by law. We collect data primarily to improve healthcare delivery and malaria monitoring.</p>
      
      <div style="text-align: right; margin-top: 20px;">
        <button type="button" class="btn-primary" id="modal-agree-btn" style="width: auto; padding: 8px 24px;">I Understand</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/htmx.org@1.9.12" 
        onerror="this.onerror=null; this.src='https://unpkg.com/htmx.org@1.9.12/dist/htmx.min.js'">
</script>

<script>
// Modal Logic
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('terms-modal');
  const termsLink = document.getElementById('terms-link');
  const privacyLink = document.getElementById('privacy-link');
  const closeBtn = document.querySelector('.close-modal');
  const agreeBtn = document.getElementById('modal-agree-btn');
  
  function openModal(e) {
    if(e) e.preventDefault();
    modal.style.display = 'flex';
  }
  
  function closeModal() {
    modal.style.display = 'none';
  }
  
  if (termsLink) termsLink.addEventListener('click', openModal);
  if (privacyLink) privacyLink.addEventListener('click', openModal);
  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  if (agreeBtn) agreeBtn.addEventListener('click', closeModal);
  
  // Close on outside click
  window.addEventListener('click', function(e) {
    if (e.target == modal) {
      closeModal();
    }
  });
});

// PAGE LOAD ANIMATION - White background with spinner
window.addEventListener('load', function() {
  // Animate loading dots
  let dots = 0;
  const loadingDots = document.getElementById('loading-dots');
  const dotsInterval = setInterval(() => {
    dots = (dots + 1) % 4;
    if (loadingDots) {
      loadingDots.textContent = 'Loading' + '.'.repeat(dots);
    }
  }, 500);
  
  // Hide loader after page fully loaded
  setTimeout(function() {
    clearInterval(dotsInterval);
    const loader = document.getElementById('page-loader');
    const content = document.getElementById('main-content');
    
    if (loader && content) {
      // Fade out loader
      loader.style.opacity = '0';
      
      // Fade in content
      setTimeout(function() {
        loader.style.display = 'none';
        content.style.opacity = '1';
        content.style.transition = 'opacity 0.3s ease-in';
      }, 200);
    }
  }, 200);
});

// FORM SUBMISSION
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('signup-form');
  const submitBtn = document.getElementById('submit-btn');
  const btnText = document.getElementById('btn-text');
  const btnSpinner = document.getElementById('btn-spinner');
  
  if (form && submitBtn && btnText && btnSpinner) {
    form.addEventListener('submit', function(e) {
      // Show loading state
      submitBtn.disabled = true;
      btnText.style.display = 'none';
      btnSpinner.style.display = 'inline-flex';
      
      // Re-enable after 10 seconds as fallback (in case of error)
      setTimeout(function() {
        submitBtn.disabled = false;
        btnText.style.display = 'inline';
        btnSpinner.style.display = 'none';
      }, 10000);
    });
  }
  
  // Auto-hide success messages after 5 seconds
  const successMessages = document.querySelectorAll('.message.success');
  successMessages.forEach(function(message) {
    setTimeout(function() {
      if (message) {
        message.style.opacity = '0';
        setTimeout(function() {
          if (message && message.parentNode) {
            message.remove();
          }
        }, 300);
      }
    }, 5000);
  });
});

// HTMX load detection
setTimeout(function() {
  if (typeof htmx === 'undefined') {
    console.warn(' HTMX failed to load. Location dropdowns may not work.');
  } else {
    console.log(' HTMX loaded successfully');
  }
}, 2000);
</script>
{% endblock %}