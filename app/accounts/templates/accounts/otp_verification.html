{% extends "accounts/base_auth.html" %}
{% load static %}

{% block title %}Verify Email{% endblock %}

{% block content %}
<div class="form-container">
  <div class="auth-logo">
    <img src="{% static 'accounts/Images/upanzi-network-logo.png' %}" alt="Company Logo">
  </div>
  
  <h2>Verify Your Email</h2>
  <p>We've sent a 6-digit verification code to <strong>{{ user_email }}</strong></p>

  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <div class="message {{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <form method="post">
    {% csrf_token %}
    
    <div class="form-field">
      <label for="otp_code">Verification Code</label>
      <input 
        type="text" 
        name="otp_code" 
        id="otp_code" 
        class="form-input" 
        placeholder="Enter 6-digit code"
        maxlength="6"
        pattern="\d{6}"
        required
        autofocus
      >
    </div>

    <button type="submit" class="btn-primary">Verify Code</button>
  </form>

  <div style="margin-top: 20px; text-align: center;">
    <p>Didn't receive the code?</p>
    <button 
      id="resend-btn" 
      class="btn-secondary"
      onclick="resendOTP()"
    >
      Resend Code
    </button>
    <p id="resend-message" style="margin-top: 10px; color: #666;"></p>
  </div>

  <p class="alt" style="margin-top: 20px;">
    <a href="{% url 'accounts:signup' %}">Back to Sign Up</a>
  </p>
</div>

<script>
function resendOTP() {
  const btn = document.getElementById('resend-btn');
  const message = document.getElementById('resend-message');
  
  btn.disabled = true;
  btn.textContent = 'Sending...';
  
  fetch("{% url 'accounts:resend_otp' %}", {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json',
    },
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      message.textContent = data.message;
      message.style.color = 'green';
      
      // Countdown timer
      let countdown = 60;
      const timer = setInterval(() => {
        btn.textContent = `Resend Code (${countdown}s)`;
        countdown--;
        
        if (countdown < 0) {
          clearInterval(timer);
          btn.disabled = false;
          btn.textContent = 'Resend Code';
        }
      }, 1000);
    } else {
      message.textContent = data.message;
      message.style.color = 'red';
      btn.disabled = false;
      btn.textContent = 'Resend Code';
    }
  })
  .catch(error => {
    message.textContent = 'An error occurred. Please try again.';
    message.style.color = 'red';
    btn.disabled = false;
    btn.textContent = 'Resend Code';
  });
}

// Auto-format OTP input
document.getElementById('otp_code').addEventListener('input', function(e) {
  this.value = this.value.replace(/\D/g, '').substring(0, 6);
});
</script>

<style>
.btn-secondary {
  background: transparent;
  color: #4f46e5;
  border: 2px solid #4f46e5;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

.btn-secondary:hover {
  background: #4f46e5;
  color: white;
}

.btn-secondary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
</style>
{% endblock %}